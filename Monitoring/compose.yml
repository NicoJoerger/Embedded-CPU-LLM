services:
  influxdb:
    image: influxdb:2
    container_name: influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: admin_password
      DOCKER_INFLUXDB_INIT_ORG: llm
      DOCKER_INFLUXDB_INIT_BUCKET: llm
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: llm_admin_token_change_me
    volumes:
      - influxdb_data:/var/lib/influxdb2
    ports:
      - "8086:8086"  # Expose InfluxDB to the host

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin_password
    volumes:
      - grafana_data:/var/lib/grafana
      - ./otel/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./otel/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"  # Expose Grafana to the host

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otelcol/otel-collector-config.yaml"]
    privileged: true
    user: "0:0"
    pid: host
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./otel/otel-collector-config.yaml:/etc/otelcol/otel-collector-config.yaml:ro
      - /:/hostfs:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
    environment:
      HOST_PROC: /hostfs/proc
      HOST_SYS: /hostfs/sys
      HOST_MOUNT_PREFIX: /hostfs
    restart: unless-stopped



volumes:
  influxdb_data:
  grafana_data:
